### 1. 数据库无法建立连接，返回“too many connections”，如何定位？

返回"too many connection"表示数据库的连接池里已经有太多连接了，无法继续创建新连接了。数据库内部有一个连接池，java系统里的数据库连接池里的连接和数据库内部连接池的连接一一对应。

* 实际案例排查思路：64g大内存机器上部署mysql，有两个java实例连接mysql，每个java实例配置的数据库连接池大小为200，当两台java实例启动时报“too many connections”，说明数据库当前建立的连接少于400个，检查my.cnf文件中配置的max connections为800，然后登录到mysql，使用命令“show variables like 'max_connections'”显示当前连接数为214个，这是由于底层linux操作系统把每个进程可以打开的文件句柄数限制为了1024额所以导致mysql最大连接数为214。

* 解决方法：在linux上输入：

  ```
  ulimit -HSn 65535  修改每个进程可以打开的最大文件句柄数为65535，
  ```

  然后使用下面命令查看是否修改成功：

  ```
  cat /etc/security/limits.conf
  cat /etc/rc.local
  ```

  查看是否修改成功查看是否修改成功



### 2. 线上数据库不定时性能抖动

* 排查过了不是之前讲过的数据库锂电池充放电问题
* 第一个原因可能是bufferPool中脏页满了，这样当执行查询语句需要将大量数据加载到缓存页时，导致bufferpool中大量的脏页需要刷入磁盘，而刷磁盘速度太慢导致这期间的查询语句执行很慢造成性能抖动
* 第二个原因可能是在执行更新语句时redo log日志文件全部被写满了，此时需要回到第一个redo log文件覆盖写，当然覆盖写之前要把第一个redo log中的更新内容全部刷入磁盘，才能执行后续的更新语句。由于覆盖写redo log导致的刷磁盘就会造成性能抖动

上面两个场景都是由于刷脏页到磁盘从而导致的性能抖动。解决方法就是尽可能优化mysql参数来减少刷脏页带来的性能抖动问题。比较核心的两个优化点: 第一是降低缓存页刷入磁盘的频率，第二是提高脏页刷入磁盘的速度

一般针对降低缓存页刷入磁盘的频率，除了给数据库采用大内存并且给bufferPool分配大内存之外来降低缓存页的填满速率外没其他办法

提高脏页刷入磁盘的速度: 

1. 部署数据库的机器使用ssd固态硬盘而不是机械硬盘，因为随机io很高。将脏页刷入磁盘是典型的随机IO场景，使用固态硬盘后还需要用fio工具测出最大io速率然后设置参数"innodb_io_capacity"来告诉数据库使用多大的IO速率把缓存页刷入磁盘
2. 参数"innodb_flush_neighbors"表示将脏页刷入磁盘时可能会把脏页相邻的其他缓存页也同时刷入磁盘，从而避免发起多次随机IO，但是这样会导致f需要刷新的脏页总量变多，如果是使用SSD随机IO速度很快，就把"innodb_flush_neighbors"参数设置为0表示禁止刷相邻缓存页，这样就能提高刷脏页速度，并且可以尽可能降低每次刷脏页对执行sql语句的影响。

### 3. 案例实战:设计陌生人社交APP的MySQL索引

系统背景:一般进入陌生人社交app后，一般是根据条件筛选不同的人并查看信息，所以是对user_info表的查询，表中需要包含省份城市，性别，身高，体重，兴趣爱好，性格特点，照片，最后一次上线时间。可能需要where，order by，limit来查询

当where与order by只能有一个走索引，一般选择让where走来过滤信息

省份、城市、性别是搜索时必定包含的三个字段，所以把这三个字段放在联合索引的左侧，

最左侧连续多个字段的原则
核心重点就是尽量利用一两个复杂的多字段联合索引，抗下80%以上的查询，然后再用一两个辅助索引抗下剩余20%的非典型查询，这样99%以上的查询都能充分利用索引，就能保证查询速度和性能

